# Windows 开发环境（基于 WSL2）\n\n以下说明解释了如何在 Windows 10 或 11 上设置 PX4 开发环境，在 [WSL2](https://learn.microsoft.com/en-us/windows/wsl/about) 内运行 Ubuntu Linux。\n\n此环境可用于构建 PX4 用于：\n\n- [Pixhawk 和其他基于 NuttX 的硬件](../dev_setup/building_px4.md#nuttx-pixhawk-based-boards)\n- [Gazebo 模拟](../sim_gazebo_gz/index.md)\n- [Gazebo-Classic 模拟](../sim_gazebo_classic/index.md)\n\n:::tip\n此设置由 PX4 开发团队支持。\n理论上该环境应该能够构建任何可以在 Ubuntu 上构建的目标。\n上面列出的是定期测试的目标。\n:::\n\n## 概述\n\n[Windows Subsystem for Linux](https://learn.microsoft.com/en-us/windows/wsl/about) ([WSL2](https://learn.microsoft.com/en-us/windows/wsl/compare-versions)) 允许用户在 Windows 上安装和运行 [Ubuntu 开发环境](../dev_setup/dev_env_linux_ubuntu.md)，_几乎_ 就像我们在 Linux 计算机上运行它一样。\n\n使用此环境，开发者可以：\n\n- 在 WSL Shell 中构建 [Ubuntu 开发环境](../dev_setup/dev_env_linux_ubuntu.md) 支持的任何模拟器或硬件目标。\n  （Ubuntu 是支持和测试最好的 PX4 开发平台）。\n- 在 Windows 上运行的 [Visual Studio Code](dev_env_windows_wsl.md#visual-studio-code-integration) 中调试代码。\n- 在 WSL 中运行的 _Linux 版 QGroundControl_ 中监控 _模拟_。\n  Linux 版 QGC 会自动连接到模拟。\n\n如果需要以下功能，则还需要 _Windows 版 QGroundControl_：\n\n- [更新真实载具](#flash-a-flight-control-board) 上的固件。\n- 监控真实载具。\n  请注意，您也可以使用它来监控模拟，但必须手动 [连接到在 WSL 中运行的模拟](#qgroundcontrol-on-windows)。\n\n::: info\n从 WSL 内部连接到 USB 设备原生不支持，但可以通过使用 [USBIPD-WIN](https://learn.microsoft.com/en-us/windows/wsl/connect-usb) 项目来实现。通过这个，您可以使用 [`upload`](../dev_setup/building_px4.md#uploading-firmware-flashing-the-board) 功能从 WSL 的命令行自动上传固件。\n:::\n\n::: info\n这种方法类似于在您 _自己的_ 虚拟机中安装 PX4，如 [Windows VM-Hosted Toolchain](../dev_setup/dev_env_windows_vm.md) 中所述。\nWSL2 的好处是其虚拟机深度集成到 Windows 中，由系统管理，并进行了性能优化。\n:::\n\n## 安装\n\n### 安装 WSL2\n\n要在 Windows 10 或 11 的新安装上安装 WSL2 和 Ubuntu：\n\n1. 确保您的计算机在 BIOS 中启用了虚拟化功能。\n   它通常被称为\"虚拟化技术\"、\"Intel VT-x\"或\"AMD-V\"。\n1. 以管理员身份打开 _cmd.exe_。\n   这可以通过按开始键，输入 `cmd`，右键单击 _命令提示符_ 条目并选择 **以管理员身份运行** 来完成。\n1. 执行以下命令以安装 WSL2 和特定的 Ubuntu 版本：\n   - 默认版本（Ubuntu 22.04）：\n\n     ```sh\n     wsl --install\n     ```\n\n   - Ubuntu 20.04 ([Gazebo-Classic 模拟](../sim_gazebo_classic/index.md))\n\n     ```sh\n     wsl --install -d Ubuntu-20.04\n     ```\n\n   - Ubuntu 22.04 ([Gazebo 模拟](../sim_gazebo_gz/index.md))\n\n     ```sh\n     wsl --install -d Ubuntu-22.04\n     ```\n\n   ::: info\n   您也可以从商店安装 [Ubuntu 20.04](https://www.microsoft.com/store/productId/9MTTCL66CPXJ) 和 [Ubuntu 22.04](https://www.microsoft.com/store/productId/9PN20MSR04DW)，这允许您使用正常的 Windows 添加/删除设置删除应用程序：\n   :::\n\n1. WSL 将提示您输入 Ubuntu 安装的用户名和密码。\n   记录这些凭据，因为您稍后会需要它们！\n\n命令提示符现在是新安装的 Ubuntu 环境中的终端。\n\n### 打开 WSL Shell\n\n所有安装和构建 PX4 的操作都必须在 WSL Shell 中完成（您可以使用用于安装 WSL2 的同一个 shell，或者打开一个新的）。\n\n如果您使用 [Windows Terminal](https://learn.microsoft.com/en-us/windows/terminal/install)，可以按图示方式打开已安装 WSL 环境的 shell，并通过关闭标签页退出。\n\n![Windows Terminal 显示如何选择 Ubuntu shell](../../assets/toolchain/wsl_windows_terminal.png)\n\n要使用命令提示符打开 WSL shell：\n\n1. 打开命令提示符：\n   - 按 Windows **开始** 键。\n   - 输入 `cmd` 并按 **Enter** 打开提示符。\n\n1. 要启动 WSL 并访问 WSL shell，执行命令：\n\n   ```sh\n   wsl -d <distribution_name>\n   ```\n\n   例如：\n\n   ```sh\n   wsl -d Ubuntu\n   ```\n\n   ```sh\n   wsl -d Ubuntu-20.04\n   ```\n\n   如果您只有一个版本的 Ubuntu，只需使用 `wsl`。\n\n输入以下命令首先关闭 WSL shell，然后关闭 WSL：\n\n```sh\nexit\nwsl -d <distribution_name> --shutdown\n```\n\n或者，在输入 `exit` 后，您可以直接关闭提示符。\n\n### 安装 PX4 工具链\n\n接下来我们在 WSL2 环境中下载 PX4 源代码，并使用正常的 _Ubuntu 安装脚本_ 来设置开发环境。\n这将安装用于 Gazebo Classic 模拟和 Pixhawk/NuttX 硬件的工具链。\n\n安装开发工具链：\n\n1. [打开 WSL2 Shell](#opening-a-wsl-shell)（如果仍然打开，可以使用用于安装 WSL2 的同一个 shell）。\n1. 执行命令 `cd ~` 切换到 WSL 的主文件夹以进行后续步骤。\n\n   :::warning\n   这很重要！\n   如果您在 WSL 文件系统之外的位置工作，会遇到诸如执行速度慢和访问权限/权限错误等问题。\n   :::\n\n1. 使用 `git`（已在 WSL2 中安装）下载 PX4 源代码：\n\n   ```sh\n   git clone https://github.com/PX4/PX4-Autopilot.git --recursive\n   ```\n\n   ::: info\n   源代码中的环境设置脚本通常适用于最近的 PX4 版本。\n   如果使用旧版本的 PX4，您可能需要 [获取特定于您版本的源代码](../contribute/git_examples.md#get-a-specific-release)。\n   :::\n\n1. 运行 **ubuntu.sh** 安装脚本，并在脚本进行过程中确认任何提示：\n\n   ```sh\n   bash ./PX4-Autopilot/Tools/setup/ubuntu.sh\n   ```\n\n   ::: info\n   这会安装用于构建 Pixhawk 和 Gazebo 或 Gazebo Classic 目标的 PX4 工具：\n   - 您可以使用 `--no-nuttx` 和 `--no-sim-tools` 选项来省略 NuttX 和/或模拟工具。\n   - 其他 Linux 构建目标未经测试（您可以通过在 WSL shell 中输入 [Ubuntu 开发环境](../dev_setup/dev_env_linux_ubuntu.md) 中的相应命令来尝试这些）。\n     :::\n\n1. 脚本完成后重启\"WSL 计算机\"（退出 shell，关闭 WSL，然后重启 WSL）：\n\n   ```sh\n   exit\n   wsl --shutdown\n   wsl\n   ```\n\n1. 切换到 WSL 主文件夹中的 PX4 仓库：\n\n   ```sh\n   cd ~/PX4-Autopilot\n   ```\n\n1. 构建 PX4 SITL 目标并测试您的环境：\n\n   ```sh\n   make px4_sitl\n   ```\n\n更多构建选项请参见 [构建 PX4 软件](../dev_setup/building_px4.md)。\n\n## Visual Studio Code 集成\n\n在 Windows 上运行的 VS Code 与 WSL 集成良好。\n\n设置集成：\n\n1. [下载](https://code.visualstudio.com/) 并在 Windows 上安装 Visual Studio Code (VS Code)，\n2. 打开 _VS Code_。\n3. 安装名为 [Remote - WSL](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl) 的扩展（市场）\n4. [打开 WSL shell](#opening-a-wsl-shell)\n5. 在 WSL shell 中，切换到 PX4 文件夹：\n\n   ```sh\n   cd ~/PX4-Autopilot\n   ```\n\n6. 在 WSL shell 中，启动 VS Code：\n\n   ```sh\n   code .\n   ```\n\n   这将打开与 WSL shell 完全集成的 IDE。\n\n   确保您始终在 Remote WSL 模式下打开 PX4 仓库。\n\n7. 下次您想要开发 WSL2 时，可以通过选择 **Open Recent**（如下图所示）非常容易地再次在 Remote WSL 模式下打开它。\n   这将为您启动 WSL。\n\n   ![](../../assets/toolchain/vscode/vscode_wsl.png)\n\n   但请注意，WSL 虚拟机的 IP 地址将已更改，因此您将无法从 Windows 版 QGC 监控模拟（您仍然可以使用 Linux 版 QGC 进行监控）\n\n## QGroundControl\n\n您可以在 WSL 或 Windows 中运行 QGroundControl 以连接到正在运行的模拟。\n如果您需要 [刷新飞控板](#flash-a-flight-control-board) 的新固件，只能从 Windows 版的 QGroundControl 中执行此操作。\n\n### WSL 中的 QGroundControl\n\n设置和使用 QGroundControl 的最简单方法是将 Linux 版本下载到您的 WSL 中。\n\n您可以在 WSL shell 中执行此操作。\n\n1. 在 Web 浏览器中，导航到 QGC [Ubuntu 下载部分](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/getting_started/download_and_install.html#ubuntu)\n1. 右键单击 **QGroundControl.AppImage** 链接，然后选择\"复制链接地址\"。\n   这将类似于 _https://d176td9ibe4jno.cloudfront.net/builds/master/QGroundControl.AppImage_\n1. [打开 WSL shell](#opening-a-wsl-shell) 并输入以下命令以下载 appimage 并使其可执行（在指示处替换 AppImage URL）：\n\n   ```sh\n   cd ~\n   wget <the_copied_AppImage_URL>\n   chmod +x QGroundControl.AppImage\n   ```\n\n1. 运行 QGroundControl：\n\n   ```sh\n   ./QGroundControl.AppImage\n   ```\n\nQGroundControl 将启动并自动连接到正在运行的模拟，允许您监控和控制您的载具。\n\n您将无法使用它来安装 PX4 固件，因为 WSL 不允许访问串行设备。\n\n### Windows 上的 QGroundControl\n\n如果您想要能够使用在 PX4 内创建的固件更新硬件，请安装 [Windows 版 QGroundControl](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/getting_started/download_and_install.html#windows)。\n\n这些步骤描述了如何连接到在 WSL 中运行的模拟：\n\n1. [打开 WSL shell](#opening-a-wsl-shell)\n2. 通过运行命令 `ip addr | grep eth0` 检查 WSL 虚拟机的 IP 地址：\n\n   ```sh\n   $ ip addr | grep eth0\n\n   6: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000\n       inet 172.18.46.131/20 brd 172.18.47.255 scope global eth0\n   ```\n\n   将 `eth0` 接口 `inet` 地址的第一部分复制到剪贴板。\n   在这种情况下：`172.18.46.131`。\n\n3. 在 QGC 中转到 **Q > Application Settings > Comm Links**\n4. 添加一个名为\"WSL\"的 UDP 链接，连接到上面复制的 IP 地址的端口 `18570`。\n5. 保存并连接到它。\n\n::: info\n每次 WSL 重启时（因为它获得动态 IP 地址），您都必须在 QGC 中更新 WSL 通信链接。\n:::\n\n## 刷新飞控板\n\n刷新自定义构建的 PX4 二进制文件必须使用 [Windows 版 QGroundControl](#qgroundcontrol-on-windows)。\n\n::: info\nWSL2 原生不提供对连接到您计算机的 Pixhawk 飞控等串行/USB 设备的直接访问。\n这意味着您无法将运行在 WSL2 内的 QGC 连接到飞控以安装固件，或使用 `upload` 命令 [在构建时上传固件](../dev_setup/building_px4.md#uploading-firmware-flashing-the-board)。\n相反，您需要将 [Windows 版 QGroundControl](#qgroundcontrol-on-windows) 连接到运行在 WSL2 中的 PX4 和飞控，以便上传固件。\n:::\n\n执行以下步骤以刷新您在 WSL 中构建的自定义二进制文件：\n\n1. 如果您还没有在 WSL 中构建二进制文件，例如使用 [WSL shell](dev_env_windows_wsl.md#opening-a-wsl-shell) 并运行：\n\n   ```sh\n   cd ~/PX4-Autopilot\n   make px4_fmu-v5\n   ```\n\n   ::: tip\n   为您的开发板使用正确的 `make` 目标。\n   `px4_fmu-v5` 可用于 Pixhawk 4 开发板。\n   :::\n\n1. 如果已连接，请断开 Pixhawk 开发板的 USB 电缆与计算机的连接。\n1. 打开 QGC 并导航到 **Q > Vehicle Setup > Firmware**。\n1. 通过 USB 连接您的 Pixhawk 开发板\n1. 连接后选择\"PX4 Flight Stack\"，勾选 **Advanced settings** 并从下面的下拉菜单中选择 _Custom firmware file ..._。\n1. 继续并选择您刚刚在 WSL 中构建的固件二进制文件。\n\n   在打开对话框中，查找左窗格中带有企鹅图标的\"Linux\"位置。\n   它通常在最底部。\n   选择路径中的文件：`Ubuntu\\home\\{your WSL user name}\\PX4-Autopilot\\build\\{your build target}\\{your build target}.px4`\n\n   ::: info\n   您可以将文件夹添加到收藏夹以便下次快速访问。\n   :::\n\n1. 开始刷新。\n\n更多信息请参见 [安装 PX4 主版本、测试版或自定义固件（加载固件）](../config/firmware.md#installing-px4-main-beta-or-custom-firmware)。\n\n## 故障排除\n\n如果您在设置过程中遇到任何问题，请查看当前的 [Microsoft WSL 安装文档](https://learn.microsoft.com/en-us/windows/wsl/install)。\n\n我们还建议您安装最新的 Windows GPU 驱动程序，并在您的 Ubuntu 环境中安装最新版本的 [kisak mesa](https://launchpad.net/~kisak/+archive/ubuntu/kisak-mesa)，以便大多数 OpenGL 功能得到模拟：\n\n```sh\nsudo add-apt-repository ppa:kisak/kisak-mesa\nsudo apt update\nsudo apt upgrade\n```